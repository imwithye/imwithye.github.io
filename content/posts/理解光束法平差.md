---
title: "理解光束法平差"
date: 2023-12-21
tags: ["Computer Vision", "算法"]
---

在学习计算机视觉的时候，一个无法避开的话题就是光束法平差（Bundle Adjustment）。光束法平差是一个后端优化常用的万金油，其本质是在一组具有误差的点和约束的关系中，寻找一个最优或者最具可能性的解。我在学习的过程中发现，大部分的书籍都在侧重介绍光束法平差的解法，或多或少都涉及大量的数学知识。然而，对于软件工程任务来说，最重要的是理解几个问题：

1. 什么时候使用光束法平差算法？
2. 光束法平差的输入和输出参数是什么？
3. 如何从工程角度优化光束法平差？

由于 Matlab 的计算机视觉工具箱中自带了光束法平差的算法，我们将使用 Matlab 作为例子，来逐步回答上面几个问题。

## 什么时候使用光束法平差算法？

### 线性拟合和最小二乘法

让我们首先来理解线性回归问题，并从中理解最小二乘法的原理。

如果我们有一堆数据，我们可以知道这些数据大概线性相关。比如一辆在高速公路上匀速行驶的汽车，行驶的路程$y$和时间$x$就形成了线性关系，我们可以把这个关系记做$y=ax$，当然我们知道$a$代表汽车的速度。那么我们如何测量这个速度呢？如果我们有一个完美的测量工具，我们只需要测量俩个点，比如时刻$x_0$的路程$y_0$，以及时刻$x_1$的路程$y_1$，我们就很容易求出$a=\frac{y_1-y_0}{x_1-x_0}$。可是所有的测量都有误差，如果我们测量了 100 个观测点，他们大概都分布在$y=ax$附近，但是哪一个$a$的值才是最好的值呢？

<div style="text-align: center; width: 100%;">
    <img src="/img-posts/理解光束法平差_01.png" style="width: 70%; margin-left: auto; margin-right: auto;" />
    蓝色点为观测数据，可以看出数据大致分布在红色线$y=80x$附近
</div>

很显然，如果蓝色点是观测数据，从图形上来看，在淡蓝色，红色，黑色三根拟合线中，红色是最佳的拟合线。但是我们如何定量的说明，“最佳”这一概念呢？

我们把时刻$x$作为我们的输入参数，我们的目标是，通过观测数据，我们推导$y$与$x$的关系。通过这个对应关系，我们希望对于任何一个时刻$x$，我们都能预测一个路程$y$。那么，如果我们观测到了$N$个观测数据，我们把他们记做$x_1, x_2, ..., x_N$，和$y_1, y_2, ..., y_N$。那么对于我们的对应关系来说，理论上我们有$ax_1, ax_2, ..., ax_N$，而且我们知道他们应该和我们的观测数据差不多。

我们应该如何定义”最佳“？我们可以说，我们找到的对应关系和我们实际数据的误差最小，那么就是最佳的对应关系。更准确的说，如果$(y_1-ax_1)^2 + (y_2-ax_2)^2 + ... + (y_N-ax_N)^2$最小，那么这一个对应关系的误差就是最小，也就是我们说的最佳对应关系。

这里的所有$x$和$y$都是已知量，即我们的观测数据，所以我们想要误差最小，实际上就变成了一个关于未知数$a$的二次函数，我们找到对应的$a$使得这个二次函数变成最小值。

此时得到的$a$的值就是我们所谓的最佳拟合线。

### 重投影误差

在相机模型模型中，对于空间中的一个点，通过投影矩阵，投影到了照片相平面上。$I = PX$，$I$表示照片相平面的坐标，$X$表示点的世界坐标，$P$是投影矩阵。其中，$P$由相机的内参和外参共同构成。内参一般是一个已知数，外参是我们需要估计的值，因此我们可以简化认为$P$是一个待估计的量。事实上，在这个等式中，只有$I$是已知量，$P$和$X$都是需要估计的值。

很显然，如果我们只有一张照片，那我们不可能估计$P$和$X$，因为在方程中我们只有一个已知量$I$。好在，当我们有多张图片的时候，我们就有一些约束关系。对于一个空间中的点$X$，他可能同时出现在多张图片中，于是我们就有了$I_1 = P_1X, I_2 = P_2X, I_3 = P_3X$。对于$I_1, I_2, I_3$我们可以通过特征提取的方法获得。同样的，对于两张图片，他们有很多相似之处，我们又有$I_{11} = P_1X_1, I_{12} = P_2X_1, I_{21} = P_1X_2, I_{22} = P_2X_2, ...$。如果，我们把$P_1$视为单位矩阵，而$P_2$是相对于$P_1$的一个变换（准确的说，我们只能将外参如此假设，而不是将整个投影矩阵，不过我们这里简化了这个表示），我们就得到了关于$P_2$和一组相点$I_1, I_2, I_3, I_4$方程组。对于后面这个方程组，我们又称为对极几何和对极约束，通过两张照片中的多个特征点，我们可以得到一个方程组

## 光束法平差的输入和输出参数是什么？

TBA

## 如何从工程角度优化光束法平差？

TBA
